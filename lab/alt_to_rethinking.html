<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Comparing Bayesian Approaches</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="alt_to_rethinking_files/libs/clipboard/clipboard.min.js"></script>
<script src="alt_to_rethinking_files/libs/quarto-html/quarto.js"></script>
<script src="alt_to_rethinking_files/libs/quarto-html/popper.min.js"></script>
<script src="alt_to_rethinking_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="alt_to_rethinking_files/libs/quarto-html/anchor.min.js"></script>
<link href="alt_to_rethinking_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="alt_to_rethinking_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="alt_to_rethinking_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="alt_to_rethinking_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="alt_to_rethinking_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro">1. Intro</a></li>
  <li><a href="#let-start-with-a-simple-example---rikz" id="toc-let-start-with-a-simple-example---rikz" class="nav-link" data-scroll-target="#let-start-with-a-simple-example---rikz">2. Let Start with a Simple Example - RIKZ</a></li>
  <li><a href="#rethinking-rikz" id="toc-rethinking-rikz" class="nav-link" data-scroll-target="#rethinking-rikz">3. Rethinking RIKZ</a></li>
  <li><a href="#stan" id="toc-stan" class="nav-link" data-scroll-target="#stan">4. stan</a>
  <ul class="collapse">
  <li><a href="#the-data-block-and-defining-things" id="toc-the-data-block-and-defining-things" class="nav-link" data-scroll-target="#the-data-block-and-defining-things">4.1 The data block and defining things</a></li>
  <li><a href="#parameters" id="toc-parameters" class="nav-link" data-scroll-target="#parameters">4.2 Parameters</a></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">4.3 Model</a></li>
  <li><a href="#executing-the-model" id="toc-executing-the-model" class="nav-link" data-scroll-target="#executing-the-model">4.4 Executing the model</a></li>
  </ul></li>
  <li><a href="#brms" id="toc-brms" class="nav-link" data-scroll-target="#brms">5. brms</a></li>
  <li><a href="#inla" id="toc-inla" class="nav-link" data-scroll-target="#inla">6. inla</a>
  <ul class="collapse">
  <li><a href="#priors-in-inla" id="toc-priors-in-inla" class="nav-link" data-scroll-target="#priors-in-inla">6.1 Priors in inla</a></li>
  <li><a href="#comparing-inla-and-rethinking-fits" id="toc-comparing-inla-and-rethinking-fits" class="nav-link" data-scroll-target="#comparing-inla-and-rethinking-fits">6.2 Comparing inla and rethinking fits</a></li>
  </ul></li>
  <li><a href="#tmbstan" id="toc-tmbstan" class="nav-link" data-scroll-target="#tmbstan">7. tmbstan</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Comparing Bayesian Approaches</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="intro" class="level2">
<h2 class="anchored" data-anchor-id="intro">1. Intro</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">fig.height=</span><span class="dv">5</span>, <span class="at">fig.width=</span><span class="dv">7</span>, <span class="at">comment=</span><span class="cn">NA</span>, </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">warning=</span><span class="cn">FALSE</span>, <span class="at">message=</span><span class="cn">FALSE</span>, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">dev=</span><span class="st">"jpeg"</span>, <span class="at">root.dir =</span> here<span class="sc">::</span><span class="fu">here</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Well. Here we are at the end of the semester of working with <a href="https://www.amazon.com/Statistical-Rethinking-Bayesian-Examples-Chapman/dp/036713991X">Statistical Rethinking</a>. And it’s time for you all to take flight on your own.</p>
<p>But, before you go, while the <a href="https://github.com/rmcelreath/rethinking">rethinking</a> package has been amazing, we know it is but a scaffold to launch fully into the Bayesian world. McElreath has done <strong>amazing</strong> things to implement so many cool features (and/or deal with people like me who pester him). But, there are other packages out there with developers whose full lives (well, a good chunk of, anyway) revolve around Bayesian software development. Some of those are general use software packages. Some are designed with very specific use cases. You can find a great jumping off point at <a href="https://github.com/dimenwarper/awesome-bayes">Awesome Bayes</a>.</p>
<p>For today, I wanted to take a quick scan of some of the solutions that <strong>you</strong> might use, and provide a few resources here and there. We’re going to work together on a common example and see how it changes, packge by package. Again, this is but a start. I’m going to focus on a mixed model with a variable slope and intercept. Maybe I’ll write another version of this in the future with, say, a GLMM, a GAM, or Gaussian Process or something wilder. Or maybe other folk will see this, get inspired, and do the same. That would be nice. Because I have fieldwork to do (eyes wetsuit in the corner that’s too dry).</p>
</section>
<section id="let-start-with-a-simple-example---rikz" class="level2">
<h2 class="anchored" data-anchor-id="let-start-with-a-simple-example---rikz">2. Let Start with a Simple Example - RIKZ</h2>
<p>I’m a fan of the Beach data from RIKZ (Rijksinstituut voor Kust en Zee), i.e., the Dutch Institute for Coastal and Marine Management. Zuur uses it in his mixed models book. Feiberg uses it in his <a href="https://statistics4ecologists-v2.netlify.app/boot#motivating-data-example-rikz-dutch-governmental-institute-data">his book</a>. It’s nice.</p>
<p>To remind you, we’re looking at species richness on nine beaches. One variable, NAP, is height of a sample relative to sea level. Low values = lower in the intertidal.</p>
<p>See. I had to get something field-work-y in here. I’m already dreaming of the lower intertidal mussel beds off of Lovells Island.</p>
<p>Because I don’t want to make this too crazy, let’s look at the relationship between tide height and log(x+1) of species richness. It’s pretty linear. Here it is with <code>lm()</code> fits. Note, I’m going to make a <code>log_richness</code> column. I’m also going to make a column where Beach (which is an integer) is a character, as for some packages that will matter later. I’ll let you know when.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Data4Ecologists)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"RIKZdat"</span>) </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># make a separate data frame for later use</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> RIKZdat <span class="sc">|&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_richness =</span> <span class="fu">log</span>(Richness<span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">Beach_c =</span> <span class="fu">as.character</span>(Beach))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d, <span class="fu">aes</span>(<span class="at">x =</span> NAP, <span class="at">y =</span> log_richness, <span class="at">color =</span> Beach_c)) <span class="sc">+</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Paired"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-1-1.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Cool! We can see the slopes and intercepts all vary a bit. There’s a general underlying trend, though. But some variation.</p>
<p><em>HEY LET’S DO A MIXED MODEL</em></p>
<p>If we were using, say, <code>lme4</code>, we’d code it up like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom.mixed)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>rikz_lme4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(log_richness <span class="sc">~</span> NAP <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                      (NAP <span class="sc">+</span> <span class="dv">1</span><span class="sc">|</span>Beach),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> d)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rikz_lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  effect   group    term                 estimate std.error statistic
  &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 fixed    &lt;NA&gt;     (Intercept)            1.86       0.153     12.2 
2 fixed    &lt;NA&gt;     NAP                   -0.528      0.102     -5.19
3 ran_pars Beach    sd__(Intercept)        0.425     NA         NA   
4 ran_pars Beach    cor__(Intercept).NAP  -0.0657    NA         NA   
5 ran_pars Beach    sd__NAP                0.254     NA         NA   
6 ran_pars Residual sd__Observation        0.331     NA         NA   </code></pre>
</div>
</div>
<p>We will hold onto that as a bit of a baseline for comparison as we move forward.</p>
</section>
<section id="rethinking-rikz" class="level2">
<h2 class="anchored" data-anchor-id="rethinking-rikz">3. Rethinking RIKZ</h2>
<p>At this point, we should all be pretty comfortable with <code>rethinking</code>. Let’s code it up with a variable slope-intercept model. We will use <code>Beach</code> as an index (it’s an integer 1-9). We will use <code>multi_normal</code> to specify our intercept and slope deviations from the grand mean.</p>
<p>For priors, let’s make slope and intercept pretty wide. Eyeballing the figure, <code>log_richness</code> goes from 0-4 and NAP from -1.4-2.3. OK, so intercept slope can be normal(2,2) and slope is normal(0,2). Too wide, likely, but, eh. We’ll set all sigmas to be exponential(2) and the correlation to lkj(1). We could make other choices, but this should do for now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rethinking</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>rikz_rethinking <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Likelihood</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    log_richness <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DGP</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b<span class="sc">*</span>NAP <span class="sc">+</span> site_dev[Beach] <span class="sc">+</span> site_slope_dev[Beach] <span class="sc">*</span> NAP,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RE</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(site_dev, site_slope_dev)[Beach] <span class="sc">~</span> </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">multi_normal</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), Rho, sigma_beach ),</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Priors</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    Rho <span class="sc">~</span> <span class="fu">dlkjcorr</span>(<span class="dv">1</span>),</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">2</span>),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    sigma_beach <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">2</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d, <span class="at">chains =</span> <span class="dv">3</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Results are pretty similar to above. As they should be.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rikz_lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  effect   group    term                 estimate std.error statistic
  &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 fixed    &lt;NA&gt;     (Intercept)            1.86       0.153     12.2 
2 fixed    &lt;NA&gt;     NAP                   -0.528      0.102     -5.19
3 ran_pars Beach    sd__(Intercept)        0.425     NA         NA   
4 ran_pars Beach    cor__(Intercept).NAP  -0.0657    NA         NA   
5 ran_pars Beach    sd__NAP                0.254     NA         NA   
6 ran_pars Residual sd__Observation        0.331     NA         NA   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rethink_coefs <span class="ot">&lt;-</span> <span class="fu">precis</span>(rikz_rethinking, <span class="at">depth =</span> <span class="dv">3</span>, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"Rho[2,1]"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_beach"</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>rethink_coefs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      mean         sd        5.5%      94.5%     rhat  ess_bulk
a               1.84586597 0.16336447  1.58470225  2.1013168 1.014808 301.22237
b              -0.53754385 0.11378226 -0.71007402 -0.3763989 1.015616 349.88723
Rho[2,1]        0.01973319 0.41465703 -0.62702861  0.6897833 1.002462 476.65837
sigma           0.36666623 0.05709385  0.28180081  0.4612161 1.002717 564.27630
sigma_beach[1]  0.45191866 0.15151914  0.26101168  0.7128389 1.001198 452.71827
sigma_beach[2]  0.23420553 0.14333865  0.03579547  0.4727332 1.044450  77.01396</code></pre>
</div>
</div>
</section>
<section id="stan" class="level2">
<h2 class="anchored" data-anchor-id="stan">4. stan</h2>
<p>OK, time for the big kahuna first. There are a LOT of <a href="https://mc-stan.org/users/interfaces/">interfaces to stan</a> that let you work in the <a href="https://mc-stan.org/users/documentation/">stan language</a>. We’ll use <a href="https://mc-stan.org/cmdstanr/">cmdstanr</a> as it underlies <code>rethinking</code> and seems to be the latest hotness (and implements a bunch of new features). We <em>can</em> write our stan models in their own file, but in this case, let’s do it right here. We can use <code>write_stan_file()</code> to make a temporary file from a text string, so we’ll take advantage of that.</p>
<p>stan code consists of a few pieces to your model. Broadly, a stan model will look like this with <code>...</code> being filled in with other stuff.</p>
<pre><code>// comments look like this - note the //
data{
  // you have to define all of your data here
  ...
}

transformed data{
  // you can make transforms of your data here
  // instead of in the data itself!
  ...
}

parameters{
  // you have to define all of your parameters here
  ...
}

transformed parameters {
  // if you have them, you can do transformation here!
  // but, if it's just a generated quantity that you
  // don't need to sample, do it later
  ...
}


model{
  // expected value
  // priors
  // random effects or other intermediaries
  // data generating process
  // here be likelihoods at the end
}

generated quantities {
  // executed after sampling
  // so things that don't need to be used
  // like likelihoods for WAIC, indirect effects, etc
  ...
}</code></pre>
<p>stan is persnickity about block order as well as, for the model, order within a block. That’s because everything is executed sequentially. Unlike rethinking models. So if you try and do something with a quantity that isn’t defined, you’re hosed. See <a href="https://mc-stan.org/docs/reference-manual/blocks.html">here</a> for more.</p>
<section id="the-data-block-and-defining-things" class="level3">
<h3 class="anchored" data-anchor-id="the-data-block-and-defining-things">4.1 The data block and defining things</h3>
<p>First in the model would be the data block. Here we define information about all inputs coming in from the data. stan does not know what each input is - what class, how much, etc. We have to tell it. This can be good, as it gives flexibility. Let’s say, for example, we were going to feed the following list to stan.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>d_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(d),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_Beaches =</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>Beach)),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">NAP =</span> d<span class="sc">$</span>NAP,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Beach =</span> d<span class="sc">$</span>Beach,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_richness =</span> d<span class="sc">$</span>log_richness</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we have a single integer that is the total sample size <code>N</code>, a single integer that is the number of beaches, <code>N_Beaches</code>, the numeric vector <code>NAP</code>, the integer vector <code>Beach</code>, and the numeric vector <code>log_richness</code></p>
<p>For the data block of code, we need to define each type. For vectors and arrays we need to specify how many elements there are. As stan is evaluated sequentially, this means we will have to specify <code>N</code> first, and then the others after.</p>
<p><code>log_richenss</code> and <code>NAP</code> will be vectors. As we require <code>Beach</code> to be an integer, we need to put it in an array. As an array, we can specify the type of class is in the array - in this case, an integer. They can also have multiple dimensions. Vectors, in contrast, are one dimensional real numbers - not integers. This is important, as we’re going to use those integers later as indices.</p>
<p>Here, our data block looks like</p>
<pre><code>data{
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; N_Beaches;
  vector[N] log_richness;
  array[N] int Beach;
  vector[N] NAP;
}</code></pre>
<p>While I’ve specified a lower bound on <code>N</code> and <code>N_Beaches</code>, that’s not necessary.</p>
<p>Note also that every line ends with a <code>;</code></p>
</section>
<section id="parameters" class="level3">
<h3 class="anchored" data-anchor-id="parameters">4.2 Parameters</h3>
<p>Next up, our parameters block. In this case, very similar in terms of syntax to our data block. I’m also going to use the same parameter names as in our rethinking model. The new thing here is a new data type, corr_matrix. This takes a single index, as it’s assumed to be a square symetric matrix with a diagonal of 1s and all values are constrained between -1 and 1.</p>
<p>Note here that we use <code>N_Beaches</code> for our random slope and intercept terms to specify the size of the parameter vectors.</p>
<pre><code>parameters{
     vector[N_Beaches] site_slope_dev;
     vector[N_Beaches] site_dev;
     corr_matrix[2] Rho;
     real a;
     real b;
     real&lt;lower=0&gt; sigma;
     vector&lt;lower=0&gt;[2] sigma_beach;
}</code></pre>
</section>
<section id="model" class="level3">
<h3 class="anchored" data-anchor-id="model">4.3 Model</h3>
<p>We don’t need any of the other code blocks for this example, so let’s hope into the model. In our model, we need to think about our code being evaluated sequentially. Hence, we have to remember to define things before we use them. This often means specifying priors first. Let’s take a look.</p>
<pre><code> // priors FIRST
  sigma_beach ~ exponential( 2 );
  sigma ~ exponential( 2 );
  b ~ normal( 0 , 2 );
  a ~ normal( 2 , 2 );
  Rho ~ lkj_corr( 1 );</code></pre>
<p>Hey! That looks pretty much JUST LIKE RETHINKING. <em>Phew</em>.</p>
<p>Next, let’s look at our random effects. Read this and drink it in, as a few things are going on here.</p>
<pre><code>  // RE SECOND
  {
    array[N_Beaches] vector[2] YY;
    
    for ( j in 1:N_Beaches ) YY[j] = [ site_dev[j] , site_slope_dev[j] ]';

    vector[2] MU;
    MU = [ 0 , 0 ]';
    YY ~ multi_normal( MU , quad_form_diag(Rho , sigma_beach) );
  }</code></pre>
<p>First, note that this is in a block itself. It doesn’t have to be, but it can help to separate it out.</p>
<p>Second, notice that we are defining an array of random effects. The array has <code>N_Beaches</code> elements. BUT each element is a vector of length 2. One intercept and one slope. arrays are the lists of stan.</p>
<p>Then we have a for loop. A for loop?!?!?! Yes. In stan, when operate on one element at a time. As such, we have to iterate over vectors. It’s not automatic. Here we are iterating over the YY array. All <code>N_Beaches</code> elements. This is the same syntax as an R for loop. For each element, we specify a vector (notice using [] instead of () as in R) that consists of the intercept and slope for element j. Remember, we defined these in parameters and they are of length <code>N_Beaches</code>.</p>
<p>Next we have to build up to our multivariate normal distribution of the random effects. We need a vector of means - but they are always 0, as we’re using non-centered parameterization for the model. We can then specify the distribution of <code>YY</code> with multi_normal.</p>
<p>Here, <code>quad_form_diag</code> is a function from stan such that <code>quad_form_diag(Sigma, tau)</code> is equivalent to <code>diag_matrix(tau) * Sigma * diag_matrix(tau)</code> - it does the work of making a covariance matrix from our matrix of standard deviations, <code>sigma_beach</code> and our correlation matrix <code>Rho</code>.</p>
<p>That’s a lot, but, we can see the building of the RE step by step.</p>
<p>Next, our data generating process. Notice how we define <code>mu</code> first. And then iterate over each and every data point with a for loop.</p>
<pre><code> // Data Generating Process THIRD
  vector[N] mu;

    for ( i in 1:N ) {
        mu[i] = a + b * NAP[i] + site_dev[Beach[i]] + site_slope_dev[Beach[i]] * NAP[i];
    }</code></pre>
<p>Take a moment to think through the indexing - particularly <code>[Beach[i]]</code> for the random effects. Think about it relative to your data.</p>
<p>Then, last, we can finally specify our likelihood, as every part of it has finally been defined.</p>
<pre><code>  log_richness ~ normal( mu , sigma );</code></pre>
</section>
<section id="executing-the-model" class="level3">
<h3 class="anchored" data-anchor-id="executing-the-model">4.4 Executing the model</h3>
<p>Now that we’ve done the work, we can put all of this together into one model using <code>write_stan_file()</code> to write our a temporary file, which we’ll save as <code>f</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stan</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">write_stan_file</span>(<span class="st">"</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="st">                </span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N_Beaches;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_richness;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int Beach;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] NAP;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="st">     vector[N_Beaches] site_slope_dev;</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="st">     vector[N_Beaches] site_dev;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="st">     corr_matrix[2] Rho;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="st">     real a;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="st">     real b;</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="st">     real&lt;lower=0&gt; sigma;</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="st">     vector&lt;lower=0&gt;[2] sigma_beach;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="st"> // priors FIRST</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_beach ~ exponential( 2 );</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ exponential( 2 );</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ normal( 0 , 2 );</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal( 2 , 2 );</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="st">  Rho ~ lkj_corr( 1 );</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="st">  // RE SECOND</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="st">  {</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N_Beaches] vector[2] YY;</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="st">    for ( j in 1:N_Beaches ) YY[j] = [ site_dev[j] , site_slope_dev[j] ]';</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[2] MU;</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="st">    MU = [ 0 , 0 ]';</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="st">    YY ~ multi_normal( MU , quad_form_diag(Rho , sigma_beach) );</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="st">  // Data Generating Process THIRD</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] mu;</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="st">    for ( i in 1:N ) {</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="st">        mu[i] = a + b * NAP[i] + site_dev[Beach[i]] + site_slope_dev[Beach[i]] * NAP[i];</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="st">  // Likelihood LAST</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="st">  log_richness ~ normal( mu , sigma );</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then use <code>cmdstan_model()</code> to compile it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compile</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>rikz_stan_mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>rikz_stan_mod</code> is an object full of functions. Try <code>rikz_stan_mod$print()</code> for example. Or</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>rikz_stan_mod<span class="sc">$</span><span class="fu">check_syntax</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each function has a help file. Finally, we can use <code>rikz_stan_mod$sample()</code> to actually run the model, much like we do with <code>ulam</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>rikz_stan <span class="ot">&lt;-</span> rikz_stan_mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d_list,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">3</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">500</span> <span class="co"># print update every 500 iters</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What’s great about this is that <code>bayesplot</code> and <code>tidybayes</code> both work very well with stan objects. If we want to get some basics, though and compare it to our rethinking fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>rethink_coefs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      mean         sd        5.5%      94.5%     rhat  ess_bulk
a               1.84586597 0.16336447  1.58470225  2.1013168 1.014808 301.22237
b              -0.53754385 0.11378226 -0.71007402 -0.3763989 1.015616 349.88723
Rho[2,1]        0.01973319 0.41465703 -0.62702861  0.6897833 1.002462 476.65837
sigma           0.36666623 0.05709385  0.28180081  0.4612161 1.002717 564.27630
sigma_beach[1]  0.45191866 0.15151914  0.26101168  0.7128389 1.001198 452.71827
sigma_beach[2]  0.23420553 0.14333865  0.03579547  0.4727332 1.044450  77.01396</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>rikz_stan<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_beach"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 10
  variable      mean median     sd    mad      q5    q95  rhat ess_bulk ess_tail
  &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 a            1.84   1.84  0.189  0.165   1.53    2.14   1.01     486.     578.
2 b           -0.523 -0.519 0.117  0.0973 -0.708  -0.339  1.00     804.     800.
3 sigma        0.366  0.360 0.0569 0.0610  0.283   0.464  1.01     405.    1353.
4 sigma_beac…  0.467  0.435 0.154  0.125   0.271   0.763  1.00     894.    1510.
5 sigma_beac…  0.236  0.225 0.138  0.131   0.0383  0.479  1.01     180.     138.</code></pre>
</div>
</div>
<p>Maybe some rounding error here and there, but, matches. (and it should, as I modified the stan code from the stan code generated by the rethinking model.)</p>
</section>
</section>
<section id="brms" class="level2">
<h2 class="anchored" data-anchor-id="brms">5. brms</h2>
<p>Some of you might be familiar with <a href="https://paul-buerkner.github.io/brms/">brms</a> via <a href="https://solomonkurz.netlify.app/">Solmon Kurz</a>’s excellent guide to <a href="https://bookdown.org/content/4857/">recoding rethinking with brms and the tidyverse</a>. Its incredibly useful, and where I first learned about <a href="https://mjskay.github.io/tidybayes/">tidybayes</a></p>
<p>(btw: Solmon, brm’s author <a href="https://paul-buerkner.github.io/">Paul Bürkner</a> and tidybayes’s <a href="https://www.mjskay.com/">Matt Kay</a> are all folk worth looking up and following on their socials for hawt bayes content)</p>
<p><code>brms</code> is great as it takes a syntax similar to <code>lme4</code> and <code>glmmTMB</code> and uses it to address Bayesian models. And the package expands all the time to accomodate more and more insane cases. The model itself we’ll be able to understand in a snap, so let’s look at priors.</p>
<p>First off, if you hit up <code>?prior</code>, you will see the delicious and readable detail of <code>brms</code> in its full form. It’s very thorough. Every parameter can have a prior object that we then put into a vector. Each and every prior takes a distribution, and then you can specify it’s class (b for coefficients, sd for standard deviations of different types, cor for correlation matrices). Within those classes, you can also specify a specific <code>coef</code> that the prior will be used for.</p>
<p>If you are ever unsure what falls where, you can also use <code>get_prior</code> to see the default settings and coefficient names</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(log_richness <span class="sc">~</span> NAP <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>              (NAP <span class="sc">+</span> <span class="dv">1</span><span class="sc">|</span>Beach_c),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">prior =</span> rikz_prior,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  prior     class      coef   group resp dpar nlpar lb ub
                 (flat)         b                                        
                 (flat)         b       NAP                              
                 lkj(1)       cor                                        
                 lkj(1)       cor           Beach_c                      
 student_t(3, 1.6, 2.5) Intercept                                        
   student_t(3, 0, 2.5)        sd                                    0   
   student_t(3, 0, 2.5)        sd           Beach_c                  0   
   student_t(3, 0, 2.5)        sd Intercept Beach_c                  0   
   student_t(3, 0, 2.5)        sd       NAP Beach_c                  0   
   student_t(3, 0, 2.5)     sigma                                    0   
       source
      default
 (vectorized)
      default
 (vectorized)
      default
      default
 (vectorized)
 (vectorized)
 (vectorized)
      default</code></pre>
</div>
</div>
<p>For our purposes, we’re going to set a vector of priors matching what we’ve done above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>rikz_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>), <span class="co"># handles intercept</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">class =</span> <span class="st">"b"</span>, <span class="at">coef =</span> <span class="st">"NAP"</span>), <span class="co"># handles intercept</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">2</span>), <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group =</span> <span class="st">"Beach_c"</span>),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">2</span>), <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"cor"</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With this created, we can just use our priors as the value for the <code>prior</code> argument in <code>brm</code>. Note, the only funky think I’d going here is using <code>Beach_c</code>, as it will play better with <code>modelbased</code> later on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>rikz_brms <span class="ot">&lt;-</span> <span class="fu">brm</span>(log_richness <span class="sc">~</span> NAP <span class="sc">+</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                      (NAP <span class="sc">+</span> <span class="dv">1</span><span class="sc">|</span>Beach_c),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prior =</span> rikz_prior,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> d,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One thing that’s nice about <code>brms</code> is that it works with <a href="https://easystats.github.io/performance/">performance</a> via <a href="https://mc-stan.org/bayesplot/">bayesplot</a>. For example</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">check_model</span>(rikz_brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-9-1.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also use other diagnostics, such as PIT plots and more! Check out <code>?pp_check</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rikz_brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-1.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-2.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(rikz_brms,  <span class="at">ndraws =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-3.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(rikz_brms, <span class="at">type =</span> <span class="st">"error_hist"</span>, <span class="at">ndraws =</span> <span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-4.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(rikz_brms, <span class="at">type =</span> <span class="st">"scatter_avg"</span>, <span class="at">ndraws =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-5.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(rikz_brms, <span class="at">type =</span> <span class="st">"stat_2d"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-6.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(rikz_brms, <span class="at">type =</span> <span class="st">"loo_pit_qq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-7.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(rikz_brms, <span class="at">type =</span> <span class="st">"loo_pit_overlay"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-10-8.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So, how does this compare to rethinking??</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compare</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>rethink_coefs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      mean         sd        5.5%      94.5%     rhat  ess_bulk
a               1.84586597 0.16336447  1.58470225  2.1013168 1.014808 301.22237
b              -0.53754385 0.11378226 -0.71007402 -0.3763989 1.015616 349.88723
Rho[2,1]        0.01973319 0.41465703 -0.62702861  0.6897833 1.002462 476.65837
sigma           0.36666623 0.05709385  0.28180081  0.4612161 1.002717 564.27630
sigma_beach[1]  0.45191866 0.15151914  0.26101168  0.7128389 1.001198 452.71827
sigma_beach[2]  0.23420553 0.14333865  0.03579547  0.4727332 1.044450  77.01396</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rikz_brms)[,<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  group    term                 estimate std.error conf.low conf.high
  &lt;chr&gt;    &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 &lt;NA&gt;     (Intercept)            1.86      0.169    1.53       2.21 
2 &lt;NA&gt;     NAP                   -0.523     0.105   -0.730     -0.293
3 Beach_c  sd__(Intercept)        0.454     0.144    0.231      0.790
4 Beach_c  sd__NAP                0.235     0.134    0.0175     0.533
5 Beach_c  cor__(Intercept).NAP   0.0144    0.434   -0.777      0.823
6 Residual sd__Observation        0.371     0.0595   0.273      0.499</code></pre>
</div>
</div>
<p>Again, rounding error.</p>
<p>Last, what if we want to see how things worked out in terms of fit? There are two options. It is almost trivial to use <code>tidybayes</code> here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>rikz_brms_predict <span class="ot">&lt;-</span> <span class="fu">linpred_draws</span>(rikz_brms, <span class="at">newdata =</span> d)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rikz_brms_predict, </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> NAP)) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> .linpred), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_richness)) <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(Beach_c))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-12-1.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Or</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rikz_brms_predict, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> NAP, <span class="at">color =</span> Beach_c)) <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="fu">aes</span>(<span class="at">y =</span> .linpred), <span class="at">.width =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_richness)) <span class="sc">+</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Paired"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-12-2.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Or you can use <a href="https://easystats.github.io/modelbased/">modelbased</a> to see both fixed and random effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>modelbased<span class="sc">::</span><span class="fu">estimate_relation</span>(rikz_brms) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-13-1.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>modelbased<span class="sc">::</span><span class="fu">estimate_relation</span>(rikz_brms, </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">include_random =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-13-2.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There’s a big community here, and one well worth diving in for models that aren’t super-complex.</p>
</section>
<section id="inla" class="level2">
<h2 class="anchored" data-anchor-id="inla">6. inla</h2>
<p><a href="https://www.r-inla.org/">inla</a> is a really interesting package that rose up to work with spatial and spatiotemporal data using laplacian approximation. The key insight of Laplacian approximation is that underlying each element of a model are latent gaussian variables. Think the random effects themselves. Once we have that at the core, there are algorithmic solutions that, while not always as precise as HMC, work very well and very fast for very complex models.</p>
<p>inla has a lot of non-standard dependencies, so you’ll need to istall it from the inla repo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"INLA"</span>,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">repos=</span><span class="fu">c</span>(<span class="fu">getOption</span>(<span class="st">"repos"</span>),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">INLA=</span><span class="st">"https://inla.r-inla-download.org/R/stable"</span>), </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dep=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are some <a href="https://becarioprecario.bitbucket.io/inla-gitbook/index.html">great bookdowns</a> out there about inla as well as <a href="https://www.r-inla.org/examples-tutorials">tutorials</a>, and you will need them. inla eschews the standard syntax of <code>lme4</code>, <code>brms</code>, and others and kinda has its own thing. While the speed is nice, I find it hard to work with, personally, and the documentation obtuse. But, let’s look at this model. We’ll start without priors.</p>
<p>First off, for REs and, really, most things other than a regression coefficient, inla uses the <code>f()</code> function inside it’s models. This is kinda like <code>mgcv</code> and how it uses <code>s()</code> for splines. But, a little different. In each one, you have to specify what model this underlying latent model this parameter is coming from. For a random intercept, for example, our rando intercepts are assumed to be independent and identically distributed, so we’ll use the <code>iid</code> model.</p>
<p>Also, Beach has to be an integer to keep track of indices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>rikz_inla_int <span class="ot">&lt;-</span> <span class="fu">inla</span>(log_richness <span class="sc">~</span> NAP <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">f</span>(Beach, <span class="at">model=</span><span class="st">"iid"</span>), </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, it would be nice if we could just add NAP to that somehow. But, inla doesn’t want us to have it nice or straightforward. Instead, we have to do some bookkeeping. In our new model, we will need to</p>
<ol type="1">
<li><p>Spcify that the model the intercept is part of is <code>iid2d</code> - because there will be two random effects and they will be correlated.</p></li>
<li><p>We will also need to say how parameters will be estimated In this case, as Beach is an index, we can just use the maximum index value and multiply it by 2 (9 intercepts, 9 slopes).</p></li>
<li><p>Then, we need a <em>new variable</em> to specify the indices for our slopes. These indices cannot be the same as those for the intercept, but have to come <em>after</em> those. So, we’ll mutate on the fly to create a new variable, Beach1 which is just the old indices plus the max of the old indices. So, 10:18 in this case.</p></li>
<li><p>For the slope, we use the construction <code>Beach1, NAP</code> which is <code>Grouping Index, Covariate</code>.</p></li>
<li><p>We also want to copy all the info on the model, n, etc. from our random intercept call. So we use <code>copy = Beach</code>.</p></li>
</ol>
<p>here’s what that all looks like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>rikz_inla <span class="ot">&lt;-</span> <span class="fu">inla</span>(log_richness <span class="sc">~</span> NAP <span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                      </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">f</span>(Beach, </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">model=</span><span class="st">"iid2d"</span>, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">n =</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">max</span>(d<span class="sc">$</span>Beach))<span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>                      </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">+</span> <span class="fu">f</span>(Beach1, NAP, </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">copy =</span> <span class="st">"Beach"</span>), </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> d <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Beach1 =</span> Beach <span class="sc">+</span> <span class="fu">max</span>(Beach)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="priors-in-inla" class="level3">
<h3 class="anchored" data-anchor-id="priors-in-inla">6.1 Priors in inla</h3>
<p>Priors in inla are a hair harder to implement. Each <code>f()</code> has a <code>hyper</code> argument where you can specify priors. For fixed effects, we need to wrap them in a <code>f()</code> function where <code>model = "linear"</code>. Right now…. they don’t seem to take hyperparameters? See <code>inla.models()$latent$linear$hyper</code> or <code>?inla.models</code></p>
<p>Anyone have any advice on linear terms, I’d love to hear it!</p>
<p>For the random effects, it’s a bit more straightforard. They take priors for their error terms - theta. But - it’s not a prior on a sd. It’s a prior in a precision, or <code>prec</code>, term. Precision = 1/variance. So, you’ll have to wrap your brain around it a bit more. And so do I, in order to translate, say, an exponential prior on a standard deviation to a precision or log precision. So I’m going to walk away until someone smarter weighs in.</p>
</section>
<section id="comparing-inla-and-rethinking-fits" class="level3">
<h3 class="anchored" data-anchor-id="comparing-inla-and-rethinking-fits">6.2 Comparing inla and rethinking fits</h3>
<p>As you can see, I’m not deep in the inla world, so don’t have a lot of experience with the diagnostics we need. BUT - we can look compare fits. Even without priors for the moment.</p>
<p>First, run this function which will make better output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>tidy.inla <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># x = model_inla</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  term_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(x<span class="sc">$</span>summary.fixed)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  re_term_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(x<span class="sc">$</span>summary.hyperpar)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">as_tibble</span>(<span class="fu">bind_rows</span>(x<span class="sc">$</span>summary.fixed, x<span class="sc">$</span>summary.hyperpar)) <span class="sc">%&gt;%</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">terms =</span> <span class="fu">c</span>(term_names, re_term_names)) <span class="sc">%&gt;%</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(terms,</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">everything</span>())</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>rethink_coefs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      mean         sd        5.5%      94.5%     rhat  ess_bulk
a               1.84586597 0.16336447  1.58470225  2.1013168 1.014808 301.22237
b              -0.53754385 0.11378226 -0.71007402 -0.3763989 1.015616 349.88723
Rho[2,1]        0.01973319 0.41465703 -0.62702861  0.6897833 1.002462 476.65837
sigma           0.36666623 0.05709385  0.28180081  0.4612161 1.002717 564.27630
sigma_beach[1]  0.45191866 0.15151914  0.26101168  0.7128389 1.001198 452.71827
sigma_beach[2]  0.23420553 0.14333865  0.03579547  0.4727332 1.044450  77.01396</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rikz_inla)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  terms         mean    sd `0.025quant` `0.5quant` `0.975quant`    mode      kld
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercep…  1.87   0.181        1.51      1.87          2.24   1.87    1.68e-7
2 NAP        -0.527  0.153       -0.831    -0.526        -0.223 -0.526   1.46e-7
3 Precision… 10.5    2.77         5.98     10.2          16.8    9.62   NA      
4 Precision…  4.93   2.23         1.88      4.51         10.5    3.75   NA      
5 Precision…  7.32   3.35         2.78      6.67         15.7    5.52   NA      
6 Rho1:2 fo… -0.0493 0.303       -0.616    -0.0521        0.533 -0.0525 NA      </code></pre>
</div>
</div>
<p>Slope and NAP not far off. To understand other terms, you can calculate sqrt(1/prec) to compare back.</p>
</section>
</section>
<section id="tmbstan" class="level2">
<h2 class="anchored" data-anchor-id="tmbstan">7. tmbstan</h2>
<p>Last, but not least as it is still growing, there is a package out there that compiles TMB models into executable stan code. It doesn’t <em>write</em> stan models, just compiles into the c-based executable and then samples using stan.</p>
<p>What’s great about this is that at the same time, Ben Bolker has been working priors into <code>glmmTMB</code> for purposes of stability. We can put the two together, and then create a model that will run in stan using glmmTMB, if you so desire.</p>
<p>The prior system is not well documented yet, and doesn’t seem to have an exponential? Also, instead of sd, we use <code>theta</code>. Here, let’s create priors for both our slopes and intercepts and then for our sd terms. I’m currently unclear on how to set a prior for the correlation term.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># glmmTMB and tmbstan</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmbstan)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>cprior <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">prior =</span> <span class="fu">c</span>(<span class="st">"normal(2,2)"</span>, <span class="st">"normal(0,2)"</span>),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">class =</span> <span class="fu">rep</span>(<span class="st">"beta"</span>, <span class="dv">2</span>),</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">coef =</span> <span class="fu">c</span>(<span class="st">"(Intercept)"</span>, <span class="st">""</span>))</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>sprior <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">prior =</span> <span class="fu">c</span>(<span class="st">"cauchy(0, 2)"</span>),</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">class =</span> <span class="fu">c</span>(<span class="st">"theta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With this, we can fit a standard <a href="https://github.com/glmmTMB/glmmTMB">glmmTMB</a> model with a <code>prior</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>rikz_glmmTMB <span class="ot">&lt;-</span> <span class="fu">glmmTMB</span>(log_richness <span class="sc">~</span> NAP <span class="sc">+</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                      (NAP <span class="sc">+</span> <span class="dv">1</span><span class="sc">|</span>Beach),</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">prior =</span> cprior,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Inside of that fit object, the <code>$obj</code> part is a <a href="https://github.com/kaskr/adcomp/wiki">Template Model Builder</a> object.. We can then feed this to <code>tmbstan()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>rikz_tmbstan <span class="ot">&lt;-</span> <span class="fu">tmbstan</span>(rikz_glmmTMB<span class="sc">$</span>obj,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">iter =</span> <span class="dv">2000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This takes a while, indicating to me that the code is not quite as optimized.</p>
<p>There is a tidier here we can use to compare</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>rethink_coefs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      mean         sd        5.5%      94.5%     rhat  ess_bulk
a               1.84586597 0.16336447  1.58470225  2.1013168 1.014808 301.22237
b              -0.53754385 0.11378226 -0.71007402 -0.3763989 1.015616 349.88723
Rho[2,1]        0.01973319 0.41465703 -0.62702861  0.6897833 1.002462 476.65837
sigma           0.36666623 0.05709385  0.28180081  0.4612161 1.002717 564.27630
sigma_beach[1]  0.45191866 0.15151914  0.26101168  0.7128389 1.001198 452.71827
sigma_beach[2]  0.23420553 0.14333865  0.03579547  0.4727332 1.044450  77.01396</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rikz_tmbstan)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">21</span>),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  term     estimate std.error
  &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;
1 beta[1]     1.82     0.143 
2 beta[2]    -0.538    0.0705
3 theta[1]   -0.936    0.322 
4 theta[2]   -3.09     0.968 
5 theta[3]  -14.8    664.    </code></pre>
</div>
</div>
<p>slopes look good. I need to have a think about the other coefficients, as a negative theta seems odd. But hopefully better documentation will come our way on doing something wild like this, and I’ll incorporate it here.</p>
<p>More work eneded, as we can see that theta is not mixing well with this model version.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(rikz_tmbstan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"theta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="alt_to_rethinking_files/figure-html/unnamed-chunk-22-1.jpeg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>